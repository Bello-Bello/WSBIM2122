<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta property="og:title" content="Chapter 6 Differential expression analysis | Omics Data Analysis" />
<meta property="og:type" content="book" />


<meta property="og:description" content="Course material for the Omics Data Analysis (WSBIM2122) course at UCLouvain." />


<meta name="author" content="Laurent Gatto" />

<meta name="date" content="2020-08-09" />

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  TeX: { equationNumbers: { autoNumber: "AMS" } }
});
</script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-AMS_CHTML-full" type="text/javascript"></script>

<meta name="description" content="Course material for the Omics Data Analysis (WSBIM2122) course at UCLouvain.">

<title>Chapter 6 Differential expression analysis | Omics Data Analysis</title>

<link href="libs/tufte-css-2015.12.29/tufte.css" rel="stylesheet" />
<link href="libs/tufte-css-2015.12.29/envisioned.css" rel="stylesheet" />
<link href="libs/msmb-css-0/msmb.css" rel="stylesheet" />
<script>
function toggle_visibility(id1, id2) {
var e = document.getElementById(id1);
var f = document.getElementById(id2);

e.style.display = ((e.style.display!='none') ? 'none' : 'block');

if(f.classList.contains('fa-plus-square')) {
    f.classList.add('fa-minus-square')
    f.classList.remove('fa-plus-square')
} else {
    f.classList.add('fa-plus-square')
    f.classList.remove('fa-minus-square')
}

}
</script>


<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }

code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="style.css" type="text/css" />

</head>

<body>



<div class="row">
<div class="col-sm-12">
<div id="TOC">
<ul class="navbar">
<li class="msmb"><p class="title">Omics Data Analysis<p><p class="author">Laurent Gatto</p>
<li class="dropdown" style="float:right">
<a href="javascript:void(0)" class="dropbtn">&#x25BE; Chapters</a>
<div class="dropdown-content">
<a href="index.html">Preamble</a>
<a href="sec-cli.html"><span class="toc-section-number">1</span> Command line interface</a>
<a href="sec-rmd.html"><span class="toc-section-number">2</span> R markdown</a>
<a href="sec-linmod.html"><span class="toc-section-number">3</span> Linear models</a>
<a href="sec-gsea.html"><span class="toc-section-number">4</span> Gene set enrichment analysis</a>
<a href="sec-hts.html"><span class="toc-section-number">5</span> High throughput sequencing</a>
<a id="active-page" href="sec-rnaseq.html"><span class="toc-section-number">6</span> Differential expression analysis</a><ul class="toc-sections">
<li class="toc"><a href="#theory-behind-deseq2"> Theory behind DESeq2</a></li>
<li class="toc"><a href="#running-deseq2"> Running DESeq2</a></li>
</ul>
<a href="sec-ms.html"><span class="toc-section-number">7</span> Mass spectrometry</a>
<a href="sec-prot.html"><span class="toc-section-number">8</span> Quantitative proteomics data analysis</a>
<a href="sec-ccl.html"><span class="toc-section-number">9</span> Conclusions</a>
<a href="sec-anx.html"><span class="toc-section-number">10</span> Annex</a>
<a href="sec-si.html"><span class="toc-section-number">11</span> Session information</a>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="row">
<div class="col-sm-12">
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd">
<html><body><div id="sec:rnaseq" class="section level1">
<h1>
<span class="header-section-number">Chapter 6</span> Differential expression analysis</h1>
<p><strong>Learning Objectives</strong></p>
<p>The goal of this chapter is</p>
<ul>
<li><p>to understand the different theorical concepts behind a differential expression analysis</p></li>
<li><p>to provide a real-life example of DE analysis analysis running DESeq2 step-by-step</p></li>
</ul>
<div id="theory-behind-deseq2" class="section level2">
<h2>
<span class="header-section-number">6.1</span> Theory behind DESeq2</h2>
<p>DESeq2 is bioconductor package widely used for differential expression analysis.
For more information read the original paper <span class="citation">(Love, Huber, and Anders <label for="tufte-mn-1" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-1" class="margin-toggle">2014<span class="marginnote">Love, M, W Huber, and S Anders. 2014. “Moderated Estimation of Fold Change and Dispersion for Rna-Seq Data with Deseq2.” <em>Genome Biology</em> 15 (5): 550–8. <a href="https://doi.org/10.1186/s13059-014-0550-8">https://doi.org/10.1186/s13059-014-0550-8</a>.</span>)</span> and the <a href="https://bioconductor.org/packages/release/bioc/vignettes/DESeq2/inst/doc/DESeq2.html">DESeq2 vignette</a>.</p>
<p>The starting point of the analysis is a count matrix, and the goal is to identify
genes that are differentially expressed between samples.</p>
<p>The different steps of the analysis are illustrated in the figure below. Briefly,
DESeq2 will start by normalising the raw counts to account for differences in library depth and
library composition. Then, it will estimate the gene-wise dispersions and shrink these
estimates to generate more accurate estimates of dispersion to model the counts. Finally,
DESeq2 will fit a negative binomial model and perform hypothesis testing using the Wald test.</p>
<p><img src="figs/deseq2_steps.png" width="60%" style="display: block; margin: auto;"></p>
<div id="normalisation" class="section level3">
<h3>
<span class="header-section-number">6.1.1</span> Normalisation</h3>
<ul>
<li><strong>Why is it mandatory to normalise?</strong></li>
</ul>
<p>Observed counts are supposed to reflect gene abundance (what we are
interested in), however they are also dependant on other less interesting
factors such as gene length, sequencing biases, sequencing depth or library
composition. Normalisation is the process of scaling raw count values to
account for the “uninteresting” factors rendering the expression levels more
comparable between and/or within samples.</p>
<ul>
<li><strong>Gene length</strong></li>
</ul>
<p>As illustrated in the example below, gene 1 and gene 2 have similar levels of expression,
but many more reads map to gene 2 than to gene 1. This might not be related to biology
but it can just reflect the fact that gene 2 is longer. Gene length normalisation is
mandatory when the purpuse is to compare expression levels between different genes within
the same sample. However, for differential expression analysis, as genes expression
levels are compared between samples, gene length normalisation is not necessary and
even not recommended. It was just mentionned here because many RNAseq common
normalisation methods such as TPM (transcript per million), FPKM (fragment per million),
or RPKM (reads per million) do normalise read counts by gene length.</p>
<p><img src="figs/read_length.png" width="100%" style="display: block; margin: auto;"></p>
<ul>
<li><strong>Sequencing depth</strong></li>
</ul>
<p>Each sequencing experiment will produce a certain number of reads expected to be
typically around tens of millions. A fraction of the raw sequencing reads will be
discarded during the quality control, the alignment and the counting processes,
which implies that the total number of reads for each sample will be different.</p>
<p>As shown below, all genes seem to be expressed at higher levels in sample 1 than
in sample 2. This is because sample 1 has twice more reads than sample 2. Accounting
for sequencing depth is necessary for differential expression analysis as samples are
compared with each other.</p>
<p><img src="figs/Sequencing_depth.png" width="100%" style="display: block; margin: auto;"></p>
<ul>
<li><strong>Library composition</strong></li>
</ul>
<p>The library composition might also be different in samples. To illustrate this,
let’s imagine a basic cell expressing only 2 genes (genes A and B) and assume that
a drug treatment induces a strong expression of gene C. If the normalisation was done
using total number of reads only, then the counts of gene A would be divided by 4 in
control cells, while it would be divided by 12 in treated cells. This would lead to the
misleading conclusion that the treatment has reduced 3 times the expression of gene A.
In this case, the library composition has changed but not the expression level of gene A.</p>
<p><img src="figs/library_composition.png" width="100%" style="display: block; margin: auto;"></p>
<p>In a real dataset, a few highly differentially expressed genes, differences in the number
of genes expressed between samples, or presence of contaminations can skew library composition.
Accounting for it is highly recommended for accurate comparison of expression between samples <span class="citation">(Anders and Huber <label for="tufte-mn-2" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-2" class="margin-toggle">2010<span class="marginnote">Anders, S, and W Huber. 2010. “Differential Expression Analysis for Sequence Count Data.” <em>Genome Biology</em> 11 (27): 10. <a href="https://doi.org/10.1186/gb-2010-11-10-r106">https://doi.org/10.1186/gb-2010-11-10-r106</a>.</span>)</span>.</p>
<ul>
<li><strong>DESeq2 normalisation method</strong></li>
</ul>
<p>DESeq2 will hence use a normalisation method that takes into account both library size
and library composition. To normalise for sequencing depth and RNA composition, DESeq2 uses
the median of ratios method.</p>
<ul>
<li>Step 1: creates a pseudo-reference sample (row-wise geometric mean)</li>
</ul>
<p>DESeq2 will calculate the geometric mean of each gene. Geometric mean is used instead of
classical mean because it uses log values. It is hence more robust as it is less influenced
by extreme values. The geometric means constitute a pseudo-reference sample.</p>
<ul>
<li>Step 2: calculates ratio of each sample to the pseudo-reference</li>
</ul>
<p>For every gene in a sample, the ratios (sample/pseudo-reference sample) are calculated.
Since the majority of genes are not differentially expressed, the majority of genes in
each sample should have similar ratios within the sample.</p>
<ul>
<li>Step 3: calculates the normalisation factor for each sample (size factor)</li>
</ul>
<p>The median value of all ratios for a given sample is taken as the size factor for that
sample. Importantly, the method is based on the assumption that the majority of genes are
not differentially expressed, which implies that rare genes that are really up-regulated /
down-regulated should not influence the median. Furthemore, the median is calcutated skipping
genes with a geometric mean of zero. This will hence automatically eliminate genes expressed
in some samples but not in others and will help to focus the scaling factor on housekeeping genes.</p>
<ul>
<li>Step 4: calculate the normalised counts using the scaling factor</li>
</ul>
<p>This is performed by dividing each raw count values in a given sample by that sample’s scaling factor.</p>
<p><img src="figs/SF_steps.png" width="100%" style="display: block; margin: auto;"></p>
</div>
<div id="count-modeling" class="section level3">
<h3>
<span class="header-section-number">6.1.2</span> Count modeling</h3>
<p>Let’s first have a look at the counts distribution for a typical RNAseq sample:</p>
<p><img src="figs/distribution_of_counts.png" width="50%" style="display: block; margin: auto;"></p>
<p>It is obvious that the count data is not normally distributed. Counts are integer values,
always positive, and we observe a large number of genes with low counts (or counts about zero),
and a a few number of genes with a very high count level.</p>
<p>As seen in the <a href="http://bit.ly/WSBIM1322">WSBIM1322 course</a> with the example of the ?toss coin,
count data are often modelised by a binomial distribution with parameters n and p where p is the
discrete probability distribution of the number of successes in a sequence of n
independent experiments. In an RNAseq experiment, p would be the probability of getting
a read associated to a particular gene given that n total number of reads were sequenced
in the experiment. However, when n is large and p is low, Poisson distribution is used
instead of binomial. It describes typically the distribution of a rare event in a large
population, which fits better to RNAseq. Indeed, for each sample, the total number of reads
tends to be in millions, while the counts per gene can vary considerably but tend to be
in tens, hundreds or thousands. Therefore, the chance of a given read to be mapped to any
specific gene is extremely small.</p>
<p>The Poisson distribution has only one parameter indicating its expected mean.
Its variance and all other properties follow from it. In particular, one key assumption
of the Poisson distribution is that the variance equals the mean. Applying a Poisson
distribution to Rnaseq counts holds true when comparing technical replicates from a same
sample, where the variance only reflects the counting noise. But when comparing biological
replicates, counting noise is not the only source of variance. The observed count values for
each genes within biological replicates fluctuate more importantly, due to the combination of
biological and technical factors: inter-individual variations in gene expression, sample purity,
cell reponses to environment (e.g. heat-shock)… Due to this overdispersion, the Poisson
distribution doesn’t fit that well to RNAseq counts.</p>
<p>Actually, RNAseq counts are better modelised by an alternative distribution,
the negative-binomial. It is derived from the Poisson distribution but the
negative-binomial distribution has, in addition tho the mean parameter,
an extra parameter <span class="math inline">\(α\)</span> called the “dispersion” parameter to model this “extra”
variance that is empirically observed in RNA-Seq experiments.</p>
<p><img src="figs/NB.png" width="50%" style="display: block; margin: auto;"></p>
</div>
<div id="dispersion-estimation" class="section level3">
<h3>
<span class="header-section-number">6.1.3</span> Dispersion estimation</h3>
<p>Having modelised counts by a negative-binomial distribution, next step is to estimate,
for each gene, the two parameters of the distribution (mean and dispersion). The mean
will be estimated easily from the observed normalized counts in both conditions, but
the dispersion is not that trivial to estimate.</p>
<p>Dispersion is a measure of spread or variability in the data (<span class="math inline">\(α= CV^2\)</span>). A gene with
a dispersion value of 0.04 means 20% variation around the expected mean. Estimate the
dispersion for each gene would be quite straightforward if we had for each condition,
hundreds of replicates. Of course, this is not feasible for economic reasons, and
experiments are usually done on only 3-5 replicates. But how to estimate dispersion
reliably based on such a little number of samples? To overcome this problem, DESeq2
makes the assumption that genes of similar expression levels have similar dispersions
and it will use information coming from other genes expressed at at similar level.</p>
<ul>
<li>Step1: Dispersion for each gene is estimated separately</li>
</ul>
<p>An initial estimation of dispersion for each gene is first estimated using maximum
likelihood estimation. In other words, given the count values of the replicates, the
most likely estimate of dispersion is calculated. For each gene, the dispersion estimate
is plotted in function of the mean expression level (mean counts of replicates).
This produce the so-called “dispersion plot” where each gene is represented by a black dot.</p>
<p><img src="figs/dispersion_plot.png" width="80%" style="display: block; margin: auto;"></p>
<p>Note that the dispersion plot highlights an intrinsic feature of RNAseq data:
genes with low read counts show substantially higher dispersion than highly expressed genes.</p>
<ul>
<li>Step 2: A curve is fitted to gene-wise dispersion estimates</li>
</ul>
<p>A curve is fitted (displayed as a red line in the dispersion plot), which represents the
estimate for the expected dispersion value for genes of a given expression strength.
The idea behind fitting a curve to the data is that different genes will have different
scales of biological variability, but, over all genes, there will be a distribution of
reasonable estimates of dispersion.</p>
<ul>
<li>Step 3: Shrink gene-wise dispersion estimates toward the values predicted by the curve</li>
</ul>
<p>Initial gene-wise dispersion estimates will be shrinked (by an empirical Bayes approach)
towards this fitted curve to obtain the final dispersion estimates. The adjusted dispersion
values are represented by the blue dots in the dispersion plot. For a certain number of genes,
the adjusted dispersion will be significantly increased and this will limit the number of
false-positive that could arise from an underestimated dispersion. Dispersion estimates
that are slightly above the curve are also shrunk toward the curve. However, genes with
extremely high dispersion<label for="tufte-sn-1" class="margin-toggle sidenote-number">1</label><input type="checkbox" id="tufte-sn-1" class="margin-toggle"><span class="sidenote"><span class="sidenote-number">1</span> genes with extremely high dispersion are those for which the adjusted
dispersion is more than 2 residual standard deviations above the curve.</span> values are not. In fact DESeq2 assumes that these
genes might not follow the modeling assumptions and could have higher variability than others
for biological or technical reasons. For these genes, shrinking the values toward the curve
could result in false positives. These genes are shown surrounded by blue circles in the
dispersion plot.</p>
<p>This shrinkage method is particularly important to reduce false positives in the
differential expression analysis. The shrunken dispersion values will be used for
fitting of the model and differential expression testing.</p>
<p><img src="figs/disp_shrinkage.png" width="80%" style="display: block; margin: auto;"></p>
</div>
<div id="glm" class="section level3">
<h3>
<span class="header-section-number">6.1.4</span> GLM</h3>
<p>Adapt this paragraph in function of Laurent’s chapter on linear models.</p>
<p>DESeq2 fits a generalized linear model of the form: <span class="math inline">\(log2(qij)=xj.βi\)</span>, and <span class="math inline">\(βi\)</span>
coefficients are computed. They give estimates of the log fold changes for gene i
for each column of the model matrix. Standard errors for the log2 fold changes are
also estimated.</p>
</div>
<div id="logfc-shrinkage" class="section level3">
<h3>
<span class="header-section-number">6.1.5</span> logFC shrinkage?</h3>
</div>
<div id="statistical-test" class="section level3">
<h3>
<span class="header-section-number">6.1.6</span> Statistical test</h3>
<div id="wald-test" class="section level4">
<h4>
<span class="header-section-number">6.1.6.1</span> Wald test</h4>
<p>The ultimate goal of a test for differential expression is to decide whether,
for a given gene, an observed difference in read counts is significant, that is,
whether it is greater than what would be expected just due to natural random variation.
The null hypothesis <span class="math inline">\(H_0\)</span> is that there is no differential expression across two sample groups,
which is the same as saying that the log2foldchange = 0. A statistical test, the Wald test,
will determine whether the data provides sufficient evidence to conclude that this value
is really different from zero.</p>
<p>For the Wald test, the log2foldchange is divided by its standard error, resulting
in a z-statistic. The z-statistic is compared to a standard normal distribution,
and a p-value is computed reporting the probability that a z-statistic at least
as extreme as the observed value would be selected at random. In principle, if this
p-value is small (below a certain cutoff) the null hypothesis is rejected.</p>
</div>
<div id="multiple-testing-correction" class="section level4">
<h4>
<span class="header-section-number">6.1.6.2</span> Multiple testing correction</h4>
<ul>
<li><strong>False discovery rate (FDR)</strong></li>
</ul>
<p>Recall that a pvalue of 0.05 means that there is only 5% chance of getting this data
if no real difference existed (if Ho was really true). In other words, choosing a cut
off of 0.05 means there is 5% chance that the wrong decision is made (resulting in a
false positive). But remember the problematic of multiple testing seen in chapter 7
from <a href="http://bit.ly/WSBIM1322">WSBIM1322 course</a>.</p>
<p>In a typical RNAseq differential expression analysis, we might have about 20,000 genes
to test and usually only a fraction of genes are really differentially expressed.
Imagine a drug treatment that modifies the expression of about 1000 genes, but that has
no impact on the other ones. The first histogram shows how the distribution of pvalues
for trully modified genes (<span class="math inline">\(H_0\)</span> is fase) would look like: most of the pvalues would be
very small. Using a pvalue cutoff of 0.05 should permit to identify most of these
differentially expressed genes. The second histogram shows the distribution of pvalues
for unmodified genes (<span class="math inline">\(H_0\)</span> is true). Here the p-values are uniformely distributed between
0 and 1, and we can see that 5% of these genes appear to be significant even though this
is only by chance as the drug had no real effect on them. But 5% of 19000 genes means …
950 false positive genes! Hence, pvalues obtained from the Wald test must be corrected
for multiple testing to avoid excess false positives.</p>
<p>By default DESeq2 uses Benjamini-Hochberg method to adjust pvalues.
The third histogram bellow illustrates the principle behind this False discovery rate (FDR)
adjustment. As differential expression analysis is done on the whole set of genes, the
resulting pvalues will have a distribution corresponding to the combination of both histograms.
Most of the p-values are uniformly distributed between 0 and 1 but there is a spike to the
left close to zero, due to those p-values for which <span class="math inline">\(H0\)</span> is false. The correction approach
helps to estimate how many of the significant values are actually false positives.
It tries to find the height where the p-value distribution flattens out (corresponding to
the red line) and incorporates this height value into the calculation of FDR adjusted p-values.
Choosing a cut off of 0.05 for padjusted values now implies that 5% of significant tests
(but not 5% of all tests as before) will result in false positives.</p>
<p><img src="figs/pval_histograms.png" width="100%" style="display: block; margin: auto;"></p>
<ul>
<li><strong>Independant filtering</strong></li>
</ul>
<p>Multiple testing adjustment tends to be associated with a loss of power.
To counteract this effect, one possibility is to filter out those tests from
the procedure that have no, or little chance of showing significant evidence,
without even looking at their test statistic. Genes with very low counts are
typically not likely to be significant due to high dispersion. However, these
genes have an influence on the multiple testing adjustment, whose performance
improves if such genes are removed. By removing the weakly-expressed genes from
the input to the FDR procedure, more significant genes can be found among those
that are kept, and this improves the power of the test. This approach is known
as independent filtering.</p>
<p>DESeq2 uses as filtering criterion the mean of normalised counts. Genes with a
mean expression value under a certain threshold are removed. Such filtering is
permissible only if the filter criterion is independent of the actual test statistic,
otherwise, the filtering would invalidate the test and consequently the assumptions
of the FDR procedure. This is why filtering is done on the average expression over
all samples, irrespective of biological condition: this filter is blind to the assignment
of samples to the treatment and control group and hence independent.</p>
<p>The mean expression threshold used by DESeq2 for independant filtering is defined
automatically by the software. It is chosen in a way that maximizes the number of
genes which will have a significant padjusted value.</p>
</div>
</div>
</div>
<div id="running-deseq2" class="section level2">
<h2>
<span class="header-section-number">6.2</span> Running DESeq2</h2>
<p>Let’s start by installing the
<a href="https://bioconductor.org/packages/release/bioc/html/DESeq2.html">DESeq2</a> package.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="cf">if</span> (<span class="op">!</span><span class="kw">require</span>(<span class="st">"DESeq2"</span>))</a>
<a class="sourceLine" id="cb1-2" data-line-number="2">    BiocManager<span class="op">::</span><span class="kw">install</span>(<span class="st">"DESeq2"</span>)</a>
<a class="sourceLine" id="cb1-3" data-line-number="3"><span class="kw">library</span>(DESeq2)</a>
<a class="sourceLine" id="cb1-4" data-line-number="4"><span class="kw">library</span>(tidyverse)</a></code></pre></div>
<p>We will run a DESeq2 analysis using real data.</p>
<div id="construct-deseqdataset-object" class="section level3">
<h3>
<span class="header-section-number">6.2.1</span> Construct DESeqDataSet object</h3>
<p>Let’s first load the count matrix and the sample metadata.
This dataset corresponds to RNAseq data done on a two cell lines
(cell lines “F” and “H”) that were grown in acid condition or not.
The aim here is to test the influence of the acidity on the transcriptome.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="kw">load</span>(<span class="st">"data/deseq2/counts.rda"</span>)</a>
<a class="sourceLine" id="cb2-2" data-line-number="2"><span class="kw">load</span>(<span class="st">"data/deseq2/coldata.rda"</span>)</a>
<a class="sourceLine" id="cb2-3" data-line-number="3">coldata</a></code></pre></div>
<pre><code>##      cell  pH  group
## F651    F 6.5 F_acid
## F652    F 6.5 F_acid
## F653    F 6.5 F_acid
## F741    F 7.4 F_norm
## F742    F 7.4 F_norm
## F743    F 7.4 F_norm
## H651    H 6.5 H_acid
## H652    H 6.5 H_acid
## H653    H 6.5 H_acid
## H741    H 7.4 H_norm
## H742    H 7.4 H_norm
## H743    H 7.4 H_norm</code></pre>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="kw">head</span>(counts)</a></code></pre></div>
<pre><code>##                 F651 F652 F653 F741 F742 F743 H651 H652 H653 H741 H742 H743
## ENSG00000223972    0    0    0    0    0    0    0    0    0    0    0    0
## ENSG00000227232    6    4    6    4    7    5   23   13   29   13   11   14
## ENSG00000278267    1    4    4    2    6    2   29   22   23   22   10   24
## ENSG00000243485    0    0    0    0    0    0    0    0    0    0    0    0
## ENSG00000284332    0    0    0    0    0    0    0    0    0    0    0    0
## ENSG00000237613    0    0    0    0    0    0    0    0    0    0    0    0</code></pre>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="kw">dim</span>(counts)</a></code></pre></div>
<pre><code>## [1] 58735    12</code></pre>
<p>Using these data, we will start by creating a <a href="https://www.rdocumentation.org/packages/DESeq2/versions/1.12.3/topics/DESeqDataSet-class">DESeqDataSet</a>,
which is a subclass of <a href="https://www.rdocumentation.org/packages/SummarizedExperiment/versions/1.2.3/topics/RangedSummarizedExperiment-class">RangedSummarizedExperiment</a> used by the DESeq2
package to store the read counts and the intermediate estimated quantities during
statistical analysis. The DESeqDataSet class enforces non-negative integer values
in the count matrix stored as the first element in the assay list. In addition, a
formula which specifies the design of the experiment (the variables that will be
used in modeling) must be provided.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1">dds &lt;-<span class="st"> </span><span class="kw">DESeqDataSetFromMatrix</span>(<span class="dt">countData =</span> counts, </a>
<a class="sourceLine" id="cb8-2" data-line-number="2">                              <span class="dt">colData =</span> coldata,</a>
<a class="sourceLine" id="cb8-3" data-line-number="3">                              <span class="dt">design =</span> <span class="op">~</span><span class="st"> </span>group) </a></code></pre></div>
<pre><code>## Warning in DESeqDataSet(se, design = design, ignoreRank): some variables in
## design formula are characters, converting to factors</code></pre>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1">dds</a></code></pre></div>
<pre><code>## class: DESeqDataSet 
## dim: 58735 12 
## metadata(1): version
## assays(1): counts
## rownames(58735): ENSG00000223972 ENSG00000227232 ... ENSG00000277475
##   ENSG00000268674
## rowData names(0):
## colnames(12): F651 F652 ... H742 H743
## colData names(3): cell pH group</code></pre>
<p>As for SummarizedExperiments (see chapter 3 from <a href="http://bit.ly/WSBIM1322">WSBIM1322 course</a>):</p>
<ul>
<li>The Quantiative data can be accessed with <code>assay()</code>.</li>
<li>The sample (columns) metadata can be access with the <code>colData()</code>
function.</li>
<li>The features (rows) metadata can be access with the <code>rowData()</code>
column.</li>
<li>Additional metadata describing the overall experiment can be
accessed with <code>metadata()</code>.</li>
</ul>
<div class="question">
<p class="question-begin">
► Question
</p>
<div class="question-body">
<p>Access the count data from the dds object and</p>
<p>plot the counts distributions of each sample.</p>
<p>How does it look like?</p>
<p class="question-end">
<span class="fa fa-square-o solution-icon"></span>
</p>
</div>
</div>
<div class="solution">
<p class="solution-begin">
► Solution<span id="sol-start-1" class="fa fa-plus-square solution-icon clickable" onclick="toggle_visibility('sol-body-1', 'sol-start-1')"></span>
</p>
<div id="sol-body-1" class="solution-body" style="display: none;">
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" data-line-number="1"><span class="kw">as_tibble</span>(<span class="kw">assay</span>(dds, <span class="dv">1</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb12-2" data-line-number="2"><span class="st">  </span><span class="kw">gather</span>(sample, <span class="dt">value =</span> counts) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb12-3" data-line-number="3"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> <span class="kw">log2</span>(counts <span class="op">+</span><span class="st"> </span><span class="dv">1</span>), <span class="dt">fill =</span> sample)) <span class="op">+</span></a>
<a class="sourceLine" id="cb12-4" data-line-number="4"><span class="st">  </span><span class="kw">geom_histogram</span>(<span class="dt">bins =</span> <span class="dv">20</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb12-5" data-line-number="5"><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span><span class="st"> </span>sample)</a></code></pre></div>
<p><img src="WSBIM2122_files/figure-html/unnamed-chunk-15-1.png" width="672"></p>
<p>Note that a “pseudo-count” was added before the log2 transformation of the counts,
to avoid elimination of counts equal to zero.</p>
<p class="solution-end">
<span class="fa fa-square-o solution-icon"></span>
</p>
</div>
</div>
</div>
<div id="run-deseq2" class="section level3">
<h3>
<span class="header-section-number">6.2.2</span> Run DESeq2</h3>
<p>The standard differential expression analysis steps are wrapped into a single
function <code>DESeq()</code>. This function will automatically run the following other functions:</p>
<ul>
<li><p><code>estimateSizeFactors()</code> (estimation of size factors)</p></li>
<li><p><code>estimateDispersions()</code> (estimation of dispersion)</p></li>
<li><p><code>nbinomWaldTest()</code> (Negative Binomial GLM fitting and Wald statistics)</p></li>
</ul>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" data-line-number="1">dds &lt;-<span class="st"> </span><span class="kw">DESeq</span>(dds)</a></code></pre></div>
<pre><code>## estimating size factors</code></pre>
<pre><code>## estimating dispersions</code></pre>
<pre><code>## gene-wise dispersion estimates</code></pre>
<pre><code>## mean-dispersion relationship</code></pre>
<pre><code>## final dispersion estimates</code></pre>
<pre><code>## fitting model and testing</code></pre>
</div>
<div id="data-exploration" class="section level3">
<h3>
<span class="header-section-number">6.2.3</span> Data exploration</h3>
<p>Before anything else, a good practice is to explore the data
and perform quality controls checks.</p>
<div id="pca" class="section level4">
<h4>
<span class="header-section-number">6.2.3.1</span> PCA</h4>
<p>It is highly recommended to starts by a PCA to assess overall similarity between the samples:</p>
<ul>
<li><p>Which samples are similar/different to each other?</p></li>
<li><p>Does this fit to the expectation from the experiment’s design?</p></li>
<li><p>Is the experimental condition the major sources of variation in the dataset?</p></li>
<li><p>Are they any sample outliers which may need to be explored further?</p></li>
</ul>
<p>Remember that if one performs PCA directly on a matrix of normalized read counts,
the result typically depends only on the few most strongly expressed genes because
they show the largest absolute differences between samples. A simple and often used
strategy to avoid this is to take the logarithm of the normalized count values plus
a small pseudocount; however, now the genes with low counts tend to dominate the
results because, due to the strong Poisson noise inherent to small count values, they
show the strongest relative differences between samples. As a solution, DESeq2 offers
the regularized-logarithm transformation <code>rlog()</code><label for="tufte-sn-2" class="margin-toggle sidenote-number">2</label><input type="checkbox" id="tufte-sn-2" class="margin-toggle"><span class="sidenote"><span class="sidenote-number">2</span> For genes with high counts, the rlog transformation differs not much from
an ordinary log2 transformation. However for genes with lower counts, the transformation
moderates the variance across the mean shrunking the values towards the genes’ averages
across all samples. See <code>?rlog</code> for more details about the function.</span>.
<code>plotPCA()</code> function can then be used on the transformed counts to generate a PCA.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb20-1" data-line-number="1">rld &lt;-<span class="st"> </span><span class="kw">rlogTransformation</span>(dds)</a></code></pre></div>
<pre><code>## -- note: fitType='parametric', but the dispersion trend was not well captured by the
##    function: y = a/x + b, and a local regression fit was automatically substituted.
##    specify fitType='local' or 'mean' to avoid this message next time.</code></pre>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb22-1" data-line-number="1"><span class="kw">plotPCA</span>(rld, <span class="dt">intgroup =</span> <span class="st">"group"</span>)</a></code></pre></div>
<p><img src="WSBIM2122_files/figure-html/PCA-1.png" width="672"></p>
<div class="question">
<p class="question-begin">
► Question
</p>
<div class="question-body">
<p>How would you interprete this PCA?</p>
<p>How does it tell us about the design of the experiment?</p>
<p class="question-end">
<span class="fa fa-square-o solution-icon"></span>
</p>
</div>
</div>
</div>
<div id="inspecting-size-factors" class="section level4">
<h4>
<span class="header-section-number">6.2.3.2</span> Inspecting size factors</h4>
<p>It is also advisable to investigate any systematic bias in the sequencing data, such as
whether one sample has been sequenced more deeply than others. One can extract size factors
using the <code>sizeFactors()</code> function.
Usually these size factors should vary around 1, indicating comparable sequencing depth.
Any large variations between samples should be noticed since it might indicate the presence
of extreme outliers.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb23-1" data-line-number="1"><span class="kw">sizeFactors</span>(dds)</a></code></pre></div>
<pre><code>##      F651      F652      F653      F741      F742      F743      H651      H652 
## 1.0708908 1.0451635 1.0756603 1.0195973 1.0878256 0.9682838 1.0034581 0.8699322 
##      H653      H741      H742      H743 
## 1.0513440 1.0451443 0.9674616 0.9390767</code></pre>
<div class="question">
<p class="question-begin">
► Question
</p>
<div class="question-body">
<p>Compare Size Factors to sequencing depth.</p>
<p class="question-end">
<span class="fa fa-square-o solution-icon"></span>
</p>
</div>
</div>
<div class="solution">
<p class="solution-begin">
► Solution<span id="sol-start-2" class="fa fa-plus-square solution-icon clickable" onclick="toggle_visibility('sol-body-2', 'sol-start-2')"></span>
</p>
<div id="sol-body-2" class="solution-body" style="display: none;">
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb25-1" data-line-number="1">SF &lt;-<span class="st"> </span><span class="kw">enframe</span>(<span class="kw">sizeFactors</span>(dds), <span class="dt">name =</span> <span class="st">"sample"</span>, <span class="dt">value =</span> <span class="st">"Size_Factor"</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb25-2" data-line-number="2"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> sample, <span class="dt">y =</span> Size_Factor)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb25-3" data-line-number="3"><span class="st">  </span><span class="kw">geom_bar</span>(<span class="dt">stat =</span> <span class="st">"identity"</span>) </a>
<a class="sourceLine" id="cb25-4" data-line-number="4"></a>
<a class="sourceLine" id="cb25-5" data-line-number="5">SD &lt;-<span class="st"> </span><span class="kw">enframe</span>(<span class="kw">colSums</span>(<span class="kw">assay</span>(dds, <span class="st">"counts"</span>)), <span class="dt">name =</span> <span class="st">"sample"</span>, <span class="dt">value =</span> <span class="st">"n_reads"</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb25-6" data-line-number="6"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> sample, <span class="dt">y =</span> n_reads)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb25-7" data-line-number="7"><span class="st">  </span><span class="kw">geom_bar</span>(<span class="dt">stat =</span> <span class="st">"identity"</span>) </a>
<a class="sourceLine" id="cb25-8" data-line-number="8"></a>
<a class="sourceLine" id="cb25-9" data-line-number="9"><span class="kw">library</span>(cowplot)</a></code></pre></div>
<pre><code>## 
## ********************************************************</code></pre>
<pre><code>## Note: As of version 1.0.0, cowplot does not change the</code></pre>
<pre><code>##   default ggplot2 theme anymore. To recover the previous</code></pre>
<pre><code>##   behavior, execute:
##   theme_set(theme_cowplot())</code></pre>
<pre><code>## ********************************************************</code></pre>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb31-1" data-line-number="1"><span class="kw">plot_grid</span>(SF, SD, <span class="dt">ncol =</span> <span class="dv">1</span>)</a></code></pre></div>
<p><img src="WSBIM2122_files/figure-html/size_factor-1.png" width="672"></p>
<p class="solution-end">
<span class="fa fa-square-o solution-icon"></span>
</p>
</div>
</div>
</div>
<div id="dispersion-plot" class="section level4">
<h4>
<span class="header-section-number">6.2.3.3</span> Dispersion plot</h4>
<p>Plotting the dispersion estimates is a useful diagnostic.
This dispersion plot is typical, with the final dispersion, estimates shrunk from the
gene-wise estimates towards the fitted estimates.</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb32-1" data-line-number="1"><span class="kw">plotDispEsts</span>(dds)</a></code></pre></div>
<p><img src="WSBIM2122_files/figure-html/dispersion_plot-1.png" width="672"></p>
</div>
</div>
<div id="results" class="section level3">
<h3>
<span class="header-section-number">6.2.4</span> Results</h3>
<p>Results can then be extracted using the <code>results()</code>function.
The <code>contrast</code> parameter allows to specify the samples to compare.
In this case, <code>contrast = c("group", "F_acid", "F_acid")</code> means that we are comparing
the group “F_acid” to the group “F_norm”.</p>
<p>Let’s inspect the results and their signification.</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb33-1" data-line-number="1">res &lt;-<span class="st"> </span><span class="kw">results</span>(dds,</a>
<a class="sourceLine" id="cb33-2" data-line-number="2">               <span class="dt">contrast =</span> <span class="kw">c</span>(<span class="st">"group"</span>, <span class="st">"F_acid"</span>, <span class="st">"F_norm"</span>))</a>
<a class="sourceLine" id="cb33-3" data-line-number="3"><span class="kw">head</span>(res)</a></code></pre></div>
<pre><code>## log2 fold change (MLE): group F_acid vs F_norm 
## Wald test p-value: group F_acid vs F_norm 
## DataFrame with 6 rows and 6 columns
##                         baseMean      log2FoldChange             lfcSE
##                        &lt;numeric&gt;           &lt;numeric&gt;         &lt;numeric&gt;
## ENSG00000223972                0                  NA                NA
## ENSG00000227232 11.2245458619586 -0.0516189682968001 0.633615980718793
## ENSG00000278267 12.5859566778601  -0.195346198555304 0.780978111253978
## ENSG00000243485                0                  NA                NA
## ENSG00000284332                0                  NA                NA
## ENSG00000237613                0                  NA                NA
##                                stat            pvalue              padj
##                           &lt;numeric&gt;         &lt;numeric&gt;         &lt;numeric&gt;
## ENSG00000223972                  NA                NA                NA
## ENSG00000227232 -0.0814672765012051 0.935070347919983 0.980402014847956
## ENSG00000278267  -0.250130183855788 0.802486674380005 0.903025575342028
## ENSG00000243485                  NA                NA                NA
## ENSG00000284332                  NA                NA                NA
## ENSG00000237613                  NA                NA                NA</code></pre>
<ul>
<li><p><strong>baseMean</strong>: The average of the normalized count values taken over all samples.</p></li>
<li><p><strong>log2FoldChange</strong>: This value indicates how much the gene or transcript’s expression
seems to have changed between the comparison and control groups<label for="tufte-sn-3" class="margin-toggle sidenote-number">3</label><input type="checkbox" id="tufte-sn-3" class="margin-toggle"><span class="sidenote"><span class="sidenote-number">3</span> In this case, as the we set the contrast as <code>c("group", "F_acid", "F_acid")</code> a
positive log2FC indicates a gene up-regulated in the acid condition compared to the normal
condition, while a negative log2FC indicate a down-regulation.</span>. It is reported
on a logarithmic scale to base 2.</p></li>
</ul>
<ul>
<li><p><strong>lfcSE</strong>: The standard error estimate for the log2FoldChange estimate</p></li>
<li><p><strong>stat</strong>: The value of the test statistic for the gene</p></li>
<li><p><strong>pvalue</strong>: The pvalue of the test for the gene</p></li>
<li><p><strong>padj</strong>: pvalue adjusted for multiple testing</p></li>
</ul>
<div class="question">
<p class="question-begin">
► Question
</p>
<div class="question-body">
<p>Inspect the results table.</p>
<p>How many genes have no padjusted value? Why?</p>
<p class="question-end">
<span class="fa fa-square-o solution-icon"></span>
</p>
</div>
</div>
<div class="solution">
<p class="solution-begin">
► Solution<span id="sol-start-3" class="fa fa-plus-square solution-icon clickable" onclick="toggle_visibility('sol-body-3', 'sol-start-3')"></span>
</p>
<div id="sol-body-3" class="solution-body" style="display: none;">
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb35-1" data-line-number="1"><span class="kw">summary</span>(res<span class="op">$</span>padj)</a></code></pre></div>
<pre><code>##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max.    NA's 
##    0.00    0.02    0.33    0.40    0.73    1.00   37882</code></pre>
<p>Let’s filter genes with no padjusted values</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb37-1" data-line-number="1">res_tbl &lt;-<span class="st"> </span><span class="kw">as_tibble</span>(res, <span class="dt">rownames =</span> <span class="st">"ENSEMBL"</span>)</a>
<a class="sourceLine" id="cb37-2" data-line-number="2">res_tbl <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb37-3" data-line-number="3"><span class="st">  </span><span class="kw">filter</span>(<span class="kw">is.na</span>(padj))</a></code></pre></div>
<pre><code>## # A tibble: 37,882 x 7
##    ENSEMBL         baseMean log2FoldChange lfcSE   stat pvalue  padj
##    &lt;chr&gt;              &lt;dbl&gt;          &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;
##  1 ENSG00000223972   0              NA     NA    NA     NA        NA
##  2 ENSG00000243485   0              NA     NA    NA     NA        NA
##  3 ENSG00000284332   0              NA     NA    NA     NA        NA
##  4 ENSG00000237613   0              NA     NA    NA     NA        NA
##  5 ENSG00000268020   0              NA     NA    NA     NA        NA
##  6 ENSG00000240361   0.159           0      4.41  0      1        NA
##  7 ENSG00000186092   0.0958          0      4.41  0      1        NA
##  8 ENSG00000238009   1.38            0.907  2.03  0.447  0.655    NA
##  9 ENSG00000239945   0              NA     NA    NA     NA        NA
## 10 ENSG00000239906   0.0793          0      4.41  0      1        NA
## # … with 37,872 more rows</code></pre>
<ul>
<li><p>Many genes with <code>padj == NA</code> correspond to genes with a <code>basemean == 0</code>.
No pvalue can be calculated because there is no variation in their counts
(equal to 0 in all samples).</p></li>
<li><p>Some of these genes do have a <code>basemean &gt; 0</code> and a pvalue, but if you look at
them carefully, they all have a very low basemean. Actually these genes are the one
that have been filtered out by the independant filtering procedure.</p></li>
</ul>
<p class="solution-end">
<span class="fa fa-square-o solution-icon"></span>
</p>
</div>
</div>
<div id="independant-filtering-exploration" class="section level4">
<h4>
<span class="header-section-number">6.2.4.1</span> Independant filtering exploration</h4>
<p>The filtering threshold that has been used to filter low count genes can be extracted
from the results metadata.</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb39-1" data-line-number="1"><span class="kw">metadata</span>(res)<span class="op">$</span>filterThreshold</a></code></pre></div>
<pre><code>## 64.4971% 
## 2.876126</code></pre>
<p>This means that genes whith basemean &lt; 2.8761264 have been filtered. This represents 64.4971% of all tested genes!</p>
<p>Remember that the filtering threshold has been fixed in a way that maximizes the number of genes which will have a significant padjusted value. We can illustrate this on the following plot, which shows the number of rejections over the basemean quantiles.</p>
<p>The threshold chosen (red vertical line) is the lowest quantile for which the number of rejections is within 1 residual standard deviation to the peak of the curve.</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb41-1" data-line-number="1"><span class="kw">as_tibble</span>(<span class="kw">metadata</span>(res)<span class="op">$</span>filterNumRej, <span class="dt">rownames =</span> <span class="st">'percent'</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb41-2" data-line-number="2"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">rename</span>(<span class="dt">quantiles =</span> theta) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb41-3" data-line-number="3"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> quantiles, <span class="dt">y =</span> numRej)) <span class="op">+</span></a>
<a class="sourceLine" id="cb41-4" data-line-number="4"><span class="st">  </span><span class="kw">geom_point</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb41-5" data-line-number="5"><span class="st">  </span><span class="kw">geom_vline</span>(<span class="dt">xintercept =</span> </a>
<a class="sourceLine" id="cb41-6" data-line-number="6">               <span class="kw">as.numeric</span>(<span class="kw">sub</span>(<span class="st">'%'</span>, <span class="dt">replacement =</span> <span class="st">''</span>, <span class="kw">names</span>(<span class="kw">metadata</span>(res)<span class="op">$</span>filterThreshold)))<span class="op">/</span><span class="dv">100</span>,</a>
<a class="sourceLine" id="cb41-7" data-line-number="7">             <span class="dt">color =</span> <span class="st">'red'</span>)</a></code></pre></div>
<p><img src="WSBIM2122_files/figure-html/unnamed-chunk-22-1.png" width="672"></p>
<div class="question">
<p class="question-begin">
► Question
</p>
<div class="question-body">
<ol style="list-style-type: decimal">
<li><p>Actually many of these genes would have been filtered anyway because
their <code>basemean == 0</code>. Evaluate how many genes were really filtered by the independant
filtering procedure.</p></li>
<li><p>Re-run the results() function on the same dds object,
but set the independant filtering parameter to FALSE.
Check how many genes have no padj?</p></li>
<li><p>Imagine another way of filtering genes with very low counts</p></li>
</ol>
<p class="question-end">
<span class="fa fa-square-o solution-icon"></span>
</p>
</div>
</div>
<div class="solution">
<p class="solution-begin">
► Solution<span id="sol-start-4" class="fa fa-plus-square solution-icon clickable" onclick="toggle_visibility('sol-body-4', 'sol-start-4')"></span>
</p>
<div id="sol-body-4" class="solution-body" style="display: none;">
<ol style="list-style-type: decimal">
<li>Actually many of these genes would have been filtered anyway because
their <code>basemean == 0</code>. Evaluate how many genes were really filtered by the independant
filtering procedure.</li>
</ol>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb42-1" data-line-number="1"><span class="co"># Number of genes with basemean == 0</span></a>
<a class="sourceLine" id="cb42-2" data-line-number="2">res_tbl <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb42-3" data-line-number="3"><span class="st">  </span><span class="kw">filter</span>(baseMean <span class="op">==</span><span class="st"> </span><span class="dv">0</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb42-4" data-line-number="4"><span class="st">  </span><span class="kw">nrow</span>()</a></code></pre></div>
<pre><code>## [1] 19220</code></pre>
<div class="sourceCode" id="cb44"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb44-1" data-line-number="1"><span class="co"># Number of genes filtered by the independant filtering procedure</span></a>
<a class="sourceLine" id="cb44-2" data-line-number="2">res_tbl <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb44-3" data-line-number="3"><span class="st">  </span><span class="kw">filter</span>(baseMean <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span> <span class="op">&amp;</span><span class="st"> </span>baseMean <span class="op">&lt;</span><span class="st"> </span><span class="kw">metadata</span>(res)<span class="op">$</span>filterThreshold) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb44-4" data-line-number="4"><span class="st">  </span><span class="kw">nrow</span>()</a></code></pre></div>
<pre><code>## [1] 18662</code></pre>
<ol start="2" style="list-style-type: decimal">
<li>Re-run the results() function on the same dds object,
but set the independant filtering parameter to FALSE.
Check how many genes have no padj?</li>
</ol>
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb46-1" data-line-number="1">res_no_IF &lt;-<span class="st"> </span><span class="kw">results</span>(dds, <span class="dt">independentFiltering =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb46-2" data-line-number="2"><span class="kw">as_tibble</span>(res_no_IF, <span class="dt">rownames =</span> <span class="st">"ENSEMBL"</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb46-3" data-line-number="3"><span class="st">  </span><span class="kw">filter</span>(<span class="kw">is.na</span>(padj)) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">nrow</span>()</a></code></pre></div>
<pre><code>## [1] 19220</code></pre>
<ol start="3" style="list-style-type: decimal">
<li>Imagine another way of filtering genes with very low counts</li>
</ol>
<div class="sourceCode" id="cb48"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb48-1" data-line-number="1"><span class="co"># filter the data to remove genes with few counts</span></a>
<a class="sourceLine" id="cb48-2" data-line-number="2">filtering_thr &lt;-<span class="st"> </span><span class="dv">5</span>  </a>
<a class="sourceLine" id="cb48-3" data-line-number="3"><span class="co"># keep genes with counts &gt; 5 in 3 or more samples</span></a>
<a class="sourceLine" id="cb48-4" data-line-number="4">keep &lt;-<span class="st"> </span><span class="kw">rowSums</span>(<span class="kw">counts</span>(dds, <span class="dt">normalized =</span> <span class="ot">TRUE</span>) <span class="op">&gt;=</span><span class="st"> </span>filtering_thr) <span class="op">&gt;=</span><span class="dv">3</span> </a>
<a class="sourceLine" id="cb48-5" data-line-number="5">dds_bis &lt;-<span class="st"> </span><span class="kw">DESeq</span>(dds[keep, ])</a></code></pre></div>
<pre><code>## using pre-existing size factors</code></pre>
<pre><code>## estimating dispersions</code></pre>
<pre><code>## found already estimated dispersions, replacing these</code></pre>
<pre><code>## gene-wise dispersion estimates</code></pre>
<pre><code>## mean-dispersion relationship</code></pre>
<pre><code>## final dispersion estimates</code></pre>
<pre><code>## fitting model and testing</code></pre>
<div class="sourceCode" id="cb56"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb56-1" data-line-number="1">res_bis &lt;-<span class="st"> </span><span class="kw">results</span>(dds_bis, </a>
<a class="sourceLine" id="cb56-2" data-line-number="2">                   <span class="dt">independentFiltering =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb56-3" data-line-number="3"></a>
<a class="sourceLine" id="cb56-4" data-line-number="4"><span class="kw">as_tibble</span>(res_bis, <span class="dt">rownames =</span> <span class="st">"ENSEMBL"</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb56-5" data-line-number="5"><span class="st">  </span><span class="kw">filter</span>(<span class="kw">is.na</span>(padj)) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">nrow</span>()</a></code></pre></div>
<pre><code>## [1] 0</code></pre>
<div class="sourceCode" id="cb58"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb58-1" data-line-number="1"><span class="kw">as_tibble</span>(res_bis, <span class="dt">rownames =</span> <span class="st">"ENSEMBL"</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb58-2" data-line-number="2"><span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(padj)) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">nrow</span>()</a></code></pre></div>
<pre><code>## [1] 20503</code></pre>
<p class="solution-end">
<span class="fa fa-square-o solution-icon"></span>
</p>
</div>
</div>
</div>
<div id="pvalues-distribution" class="section level4">
<h4>
<span class="header-section-number">6.2.4.2</span> pvalues distribution</h4>
<p>Another useful diagnostic plot is the histogram of the p values.</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb60-1" data-line-number="1"><span class="kw">hist</span>(res_tbl<span class="op">$</span>pvalue)</a></code></pre></div>
<p><img src="WSBIM2122_files/figure-html/unnamed-chunk-26-1.png" width="672"></p>
<div class="sourceCode" id="cb61"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb61-1" data-line-number="1"><span class="kw">metadata</span>(res)<span class="op">$</span>filterThreshold</a></code></pre></div>
<pre><code>## 64.4971% 
## 2.876126</code></pre>
<div class="sourceCode" id="cb63"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb63-1" data-line-number="1"><span class="kw">par</span>(<span class="dt">mfrow=</span><span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">1</span>))</a>
<a class="sourceLine" id="cb63-2" data-line-number="2"><span class="kw">plot</span>(<span class="kw">metadata</span>(res)<span class="op">$</span>filterNumRej, <span class="dt">type =</span> <span class="st">"b"</span>, <span class="dt">xlab =</span> <span class="st">"Quantiles of filter"</span>,</a>
<a class="sourceLine" id="cb63-3" data-line-number="3">     <span class="dt">ylab =</span> <span class="st">"Number of rejections"</span>, <span class="dt">main =</span> <span class="st">"6.5 vs 7.4 for all cells"</span>)</a>
<a class="sourceLine" id="cb63-4" data-line-number="4"><span class="kw">lines</span>(<span class="kw">metadata</span>(res)<span class="op">$</span>lo.fit, <span class="dt">col =</span> <span class="st">"red"</span>)</a>
<a class="sourceLine" id="cb63-5" data-line-number="5"><span class="kw">abline</span>(<span class="dt">v =</span> <span class="kw">metadata</span>(res)<span class="op">$</span>filterTheta)</a></code></pre></div>
</div>
<div id="results-1" class="section level4">
<h4>
<span class="header-section-number">6.2.4.3</span> Results</h4>

</div>
</div>
</div>
</div></body></html>

<p style="text-align: center;">
<a href="sec-hts.html"><button class="btn btn-default">Previous</button></a>
<a href="sec-ms.html"><button class="btn btn-default">Next</button></a>
</p>
<p class="build-date">Page built: 
2020-08-09
</p>
</div>
</div>



</body>
</html>
